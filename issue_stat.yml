- name: "1.7.5 Ensure permissions on /etc/issue are configured (Automated)"
  hosts: workstation
  become: true
  tasks:
    - name: Audit
      block:
      - name: Gather info on issue file
        stat:
          path: /etc/issue
        register: res

      - name: Fail if we do not find issue file
        fail: 
          msg: issue file not present!
        when: not res.stat.exists

      - name: Fail if permissions are incorrect
        fail:
          msg: "Permissions are not compliant, they are: mode={{res.stat['mode']}}, gid={{res.stat['gid']}}, uid={{res.stat['uid']}}"
        when: (res.stat['mode']!="0644") or (res.stat['gid']!=0) or (res.stat['uid']!=0) and (res.stat.exists)
      
      rescue:
        - debug:
            msg: |
              Audit found following:
              {% if res.stat.exists %}
                Your issue permissions are not compliant!
              {% else %}
                Your issue is not present!
              {% endif %}
      tags:
      - audit
    
    - name: Remediation
      block:
      - name: Warn if the file is not present
        debug:
          msg: Your issue is not present!
        when: not res.stat.exists
      - name: Set compliant permissions
        file:
          path: /etc/issue
          owner: root
          group: root
          mode: u=rw,g=r,o=r
        when: res.stat.exists   
      tags:
        - remediation  